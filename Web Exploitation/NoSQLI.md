---
sort : 5 
---

# NoSQL Injection 

# What are NoSQL databases (aka "not only SQL") ??

are non-tabular (`non-relational`) databases and store data differently than relational tables.
they come in a variety of types based on their data model. The main types are document (similar to `JSON` objects), key-value, wide-column, and graph.

MongoDB is document based, uses the Binary JSON (`BSON`) data format.

## RDBMS vs NoSQL: Data Modeling Example

[Here](https://www.mongodb.com/nosql-explained)


## SQL vs NoSQL Injection

in SQL injection user input processed to modify or replace `SQL queries` that the application sends to a database engine.

NoSQL databases `don't` use a common query language.

NoSQL query syntax is product-specific and queries are written in the programming language of the application: PHP, JavaScript, Python, Java, and so on. 

his means that a successful injection lets the attacker execute commands not only in the database, but also in the application itself, which can be far more dangerous.


## MongoDB with PHP

```php
$collection->find(array(
    "username" => $_GET['username'],
    "passwd" => $_GET['passwd']
));

// equivalent to 

mysql_query("SELECT * FROM collection WHERE username=" . $_GET['username'] . " AND passwd=" . $_GET['passwd'])
```
How to Inject the queries ??

```php
// in sql
login.php?username=admin&passwd=" OR 1 -- -
```

```php
// in nosql 
login.php?username=admin&passwd[$ne]=1      

// So the query becomes 
$collection->find(array(
    "username" => "admin",
    "passwd" => array("$ne" => 1)
));

// equivalent to 
mysql_query("SELECT * FROM collection WHERE username='admin' AND passwd !=1"); // always ture, unless the password == 1 ^^ 
```

```php
// simply preventing the attack
$collection->find(array(
    "username" => (string)$_GET['username'],
    "passwd" => (string)$_GET['passwd']
));
```











## MongoDB Injection in PHP

```php
$query = array("user" => $_POST["username"], "password" => $_POST["password"]);

// the array in php is just like a dict in python ^^ 

// and when i say query from now on, i mean the variable $query
```

If this query is then used to check login credentials, the attacker can abuse `PHPâ€™s built-in associative array processing` to inject a MongoDB query that always returns true and bypass the authentication process. This may be as simple as sending the following POST request:

```php
username[$ne]=1&password[$ne]=1
```

PHP will translate this into an array of arrays:

```php
array("username" => array("$ne" => 1), "password" => array("$ne" => 1));
```

When sent as a MongoDB query to a user store, this will find all users where the user name and password are not equal to 1, which is highly likely to be true and may allow the attacker to bypass authentication.






























































Start MongoDB.

You can start the mongod process by issuing the following command:

sudo systemctl start mongod


By default, MongoDB runs using the mongodb user account. If you change the user that runs the MongoDB process, you must also modify the permission to the data and log directories to give this user access to these directories.







sudo nano /etc/mongod.conf
security:
  authorization: enabled  




```bash
$ mongosh

# By default, there are three databases that are created upon installation. (admin, config, local)
test> show dbs

# To create a database with "use"
test> use users


# create a user for the DB
users> db.createUser(
... {
..... user: "test",
..... pwd: "test123",                                   # password 
..... roles: [ { role: "readWrite", db: "users"} ]
..... }
... )
{ ok: 1 }()


# list users 
users> show users
[
  {
    _id: 'users.test',
    userId: UUID("18a00b62-6d59-41de-adec-73f4e265d0c6"),
    user: 'test',
    db: 'users',
    roles: [ { role: 'readWrite', db: 'users' } ],
    mechanisms: [ 'SCRAM-SHA-1', 'SCRAM-SHA-256' ]
  }
]
```








```bash
$ mongosh -u 'test' -p 'test123' "mongodb://127.0.0.1/users"

# OR 

$ mongosh "mongodb://test:test123@127.0.0.1:27017/users"
```








```bash
# If a collection does not exist, MongoDB creates the collection when you first store data for that collection.


# insert some data 
users> db.staff.insertOne({username : "hacker", password : "hacker123", city: "London", married: true, hobbies: ["Travelling", "Swimming", "Cooking"]})


users> show collections
staff


# retrieve all data 
users> db.staff.find()
[
  {
    _id: ObjectId("62dc609413fc8ea83f77791a"),
    username: 'hacker',
    password: 'hacker123',
    city: 'London',
    married: true,
    hobbies: [ 'Travelling', 'Swimming', 'Cooking' ]
  }
]


# find With filter 
users> db.staff.find({ username: "hacker", password: "hacker123456" })
# Null !! 

users> db.staff.find({ username: "hacker", password: "hacker123" })
[
  {
    _id: ObjectId("62dc609413fc8ea83f77791a"),
    username: 'hacker',
    password: 'hacker123',
    city: 'London',
    married: true,
    hobbies: [ 'Travelling', 'Swimming', 'Cooking' ]
  }
]


# using comparison operators ($lt, $gt, $ne, ...)
users> db.staff.find({ username: "hacker", password: {$ne : -1 }})
[
  {
    _id: ObjectId("62dc609413fc8ea83f77791a"),
    username: 'hacker',
    password: 'hacker123',
    city: 'London',
    married: true,
    hobbies: [ 'Travelling', 'Swimming', 'Cooking' ]
  }
]

# the above query means, find in staff collection from users database any thing that matches : 
# 1. username = hacker 
# 2. password != -1       ^^ ==> NoSQL injection 


# using regex  ==>  { <field>: { $regex: 'pattern', $options: '<options>' } }
users> db.staff.find({ username: "hacker", password: {$regex : '^h'}})
# OR 
users> db.staff.find({ username: "hacker", password: {$regex : '^[a-z]'}})
[
  {
    _id: ObjectId("62dc609413fc8ea83f77791a"),
    username: 'hacker',
    password: 'hacker123',
    city: 'London',
    married: true,
    hobbies: [ 'Travelling', 'Swimming', 'Cooking' ]
  }
]

# means the first char from the password field is 'h' or one of the char between [a-z]




```







# PHP Code Example 




```bash
# install mongodb from the docs 

# install php >= 8 
$ sudo apt-get install php-mongodb

$ mkdir "PHP"
$ cd PHP
$ composer require mongodb/mongodb

$ nano test.php     # write the php code below  
$ php test.php
```



>## test.php
```php
require 'vendor/autoload.php'; // include Composer's autoloader

$client = new MongoDB\Client(
    "mongodb://test:test123@127.0.0.1:27017/users"
);

// DBname->CollectionName
$collection = $client->users->staff;

$result = $collection->find(array(
    "username" => "hacker",
    "password" => "hacker123"
));


foreach ($result as $entry) {
    echo $entry['username'], ': ', $entry['password'], "\n";
}
?>
```

```php
$result = $collection->find(array(
    "username" => "hacker",
    "password" => array('$ne' => -1)    # '$ne' not "$ne"
));


foreach ($result as $entry) {
    echo $entry['username'], ': ', $entry['password'], "\n";
}
```

```php
# Vulnerable example !! 
$result = $collection->find(array(
    "username" => $_GET['username'],
    "password" => $_GET['password']
));

```